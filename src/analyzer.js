// src/analyzer.js
require("dotenv").config();
const OpenAI = require("openai");
const client = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

/**
 * corp_merged.json êµ¬ì¡° ì˜ˆì‹œ (êµ­ë‚´ ê¸°ì—…ë§Œ ì¡´ì¬)
 * {
 *   "name": "SKí•˜ì´ë‹‰ìŠ¤",
 *   "country": "Korea",
 *   "is_listed": true,
 *   "stockCode": "000660",
 *   "ticker": null
 * }
 */
const corpList = require("./data/corp_merged.json");

// êµ­ë‚´ ê¸°ì—… ë§µ êµ¬ì„±
const corpMap = {};
for (const c of corpList) {
  corpMap[c.name] = c;
}
const corpSet = new Set(Object.keys(corpMap));

/**
 * LLM ì¶œë ¥ ì •ì œ
 * - ```json / ``` ì œê±°
 * - í˜¹ì‹œ ì„ì¼ ìˆ˜ ìˆëŠ” // ì£¼ì„ ì œê±° (ìµœí›„ ë°©ì–´ì„ )
 */
function cleanJSON(raw) {
  return raw
    .replace(/```json/g, "")
    .replace(/```/g, "")
    .replace(/\/\/.*$/gm, "")
    .trim();
}

/**
 * mapped_name ì •ê·œí™”
 * - êµ­ë‚´ ê¸°ì—…: corp_merged.json ê³µì‹ëª… ìœ ì§€
 * - í•´ì™¸ ê¸°ì—…: mapped_name ë¹„ì–´ ìˆìœ¼ë©´ original_mentionìœ¼ë¡œ ê°•ì œ í†µì¼
 */
function normalizeMappedName(result) {
  if (!result?.companies) return result;

  for (const company of Object.values(result.companies)) {
    // í•´ì™¸ ê¸°ì—…
    if (company.country !== "Korea") {
      if (!company.mapped_name || company.mapped_name.trim() === "") {
        company.mapped_name = company.original_mention;
      }
    }
  }
  return result;
}

async function analyzeArticle(article) {
  let prompt = `
ë‹¹ì‹ ì€ ê¸ˆìœµ ë‰´ìŠ¤ ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ì•„ë˜ ê·œì¹™ì„ ì ˆëŒ€ì ìœ¼ë¡œ ì¤€ìˆ˜í•˜ì—¬ "ìˆœìˆ˜ JSON"ë§Œ ì¶œë ¥í•˜ì„¸ìš”.

============================================================
âš ï¸ JSON ì¶œë ¥ ê·œì¹™ (ì ˆëŒ€ ì¤€ìˆ˜)
============================================================
- ì¶œë ¥ì€ ë°˜ë“œì‹œ JSONë§Œ í—ˆìš©í•©ë‹ˆë‹¤.
- JSON ì™¸ì˜ ë§, ì„¤ëª…, ì˜ˆì‹œ, ì£¼ì„(//, /* */)ì€ ì ˆëŒ€ í¬í•¨í•˜ë©´ ì•ˆ ë©ë‹ˆë‹¤.
- ëª¨ë“  ê°’ì€ JSON ë¬¸ë²•ì— ë§ì•„ì•¼ í•©ë‹ˆë‹¤.
- ê°’ì´ ì—†ì„ ë•ŒëŠ” í¬í•¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

============================================================
ğŸ“Œ 0. ë‰´ìŠ¤ ìš”ì•½
============================================================

ë‹¤ìŒ ë‰´ìŠ¤ ë‚´ìš©ì„ í•œëˆˆì— ì´í•´í•  ìˆ˜ ìˆë„ë¡,
ì´ ë‰´ìŠ¤ì˜ ì„±ê²©ê³¼ íŒŒê¸‰ ë²”ìœ„ë¥¼
ë‘ ê°œì˜ ì§§ì€ ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•´ì¤˜.

ì¡°ê±´:
- ì–´ë–¤ ê¸°ì—…ì´ë‚˜ ì‚°ì—…ì´ ì—°ê´€ë  ìˆ˜ ìˆëŠ”ì§€ ì–¸ê¸‰í•  ê²ƒ
- ë‰´ìŠ¤ì˜ í•µì‹¬ ì´ìŠˆì™€ ì˜í–¥ì„ ë°›ì„ ìˆ˜ ìˆëŠ” ëŒ€ìƒë§Œ ì¤‘ë¦½ì ìœ¼ë¡œ ìš”ì•½í•  ê²ƒ
- ìš”ì•½ ê²°ê³¼ëŠ” ë°˜ë“œì‹œ ì•„ë˜ í•„ë“œë¡œ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.

"summary": ""

============================================================
ğŸ“Œ 1. ê¸°ì—… ë§¤í•‘ ê·œì¹™
============================================================
- êµ­ë‚´ ê¸°ì—… ëª©ë¡ì€ corp_merged.jsonì—ë§Œ ì¡´ì¬í•©ë‹ˆë‹¤.
- êµ­ë‚´ ê¸°ì—…:
  - mapped_nameì€ ë°˜ë“œì‹œ corp_merged.jsonì˜ ê³µì‹ ê¸°ì—…ëª…ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
- í•´ì™¸ ê¸°ì—…:
  - corp_merged.jsonì— ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
  - mapped_nameì€ original_mentionê³¼ ë™ì¼í•˜ê²Œ í•©ë‹ˆë‹¤.
  - mapped_nameì€ null ë˜ëŠ” ë¹ˆ ë¬¸ìì—´ì„ í—ˆìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

ğŸ“Œ ì‚¬ìš© ê°€ëŠ¥í•œ êµ­ë‚´ ê¸°ì—… ì „ì²´ ëª©ë¡:
{{CORP_LIST}}

============================================================
ğŸ“Œ 2. ê¸ˆìœµ ê³„ì—´ì‚¬ â†’ ì§€ì£¼ì‚¬ í†µí•© ê·œì¹™ (ë§¤ìš° ì¤‘ìš”)
============================================================
ë‹¤ìŒ ê¸°ì—…ë“¤ì€ ë°˜ë“œì‹œ ì•„ë˜ì˜ "ì§€ì£¼ì‚¬ ê³µì‹ëª…"ìœ¼ë¡œ ì •ê·œí™”í•©ë‹ˆë‹¤.

- "ì‹ í•œì€í–‰", "ì‹ í•œíˆ¬ìì¦ê¶Œ", "ì‹ í•œì¹´ë“œ", "ì‹ í•œë¼ì´í”„" â†’ "ì‹ í•œì§€ì£¼"
- "KBì¦ê¶Œ", "KBêµ­ë¯¼ì€í–‰", "KBì†í•´ë³´í—˜" â†’ "KBê¸ˆìœµ"
- "NHíˆ¬ìì¦ê¶Œ", "NHë†í˜‘ì€í–‰" â†’ "ë†í˜‘ê¸ˆìœµ"
- "ìš°ë¦¬ì€í–‰", "ìš°ë¦¬ì¹´ë“œ" â†’ "ìš°ë¦¬ê¸ˆìœµì§€ì£¼"

âš ï¸ ìœ„ì— ì–¸ê¸‰ëœ ê³„ì—´ì‚¬ëª…ì´ ë“±ì¥í•˜ë©´ mapped_nameì€ ë°˜ë“œì‹œ ì§€ì£¼ì‚¬ëª…ìœ¼ë¡œ ë°”ê¿‰ë‹ˆë‹¤.

============================================================
ğŸ“Œ 3. stock_code ìƒì„± ê·œì¹™
============================================================
ê° ê¸°ì—… object ë‚´ë¶€ì— ë°˜ë“œì‹œ ì•„ë˜ í•„ë“œë“¤ì´ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤:

"stock_code": ê°’

ê·œì¹™:
1) êµ­ë‚´ ê¸°ì—… (country = "Korea")
   - stock_code = corp_merged.json ì•ˆì˜ stockCode
   - ì—†ë‹¤ë©´ ë°˜ë“œì‹œ null

2) í•´ì™¸ ê¸°ì—… (country â‰  "Korea")
   - ìƒì¥ë¨ â†’ stock_code = ticker
   - ë¹„ìƒì¥ â†’ stock_code = null

âš ï¸ ì„ì˜ ìˆ«ì ìƒì„± ê¸ˆì§€  
âš ï¸ ì˜ˆì‹œìš© ì½”ë“œ ë„£ê¸° ê¸ˆì§€  
âš ï¸ ê°’ì´ ì—†ìœ¼ë©´ ë°˜ë“œì‹œ nullì´ì–´ì•¼ í•¨

============================================================
ğŸ“Œ 4. companies ìŠ¤í‚¤ë§ˆ (í•„ìˆ˜ êµ¬ì¡°) - mapped_nameê³¼ sentimentê°€ ë°˜ë“œì‹œ í¬í•¨ë˜ì–´ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
============================================================
"companies": {
  "ê¸°ì—…ëª…": {
    "original_mention": "",
    "mapped_name": "",
    "listing_status": "ìƒì¥ | ë¹„ìƒì¥",
    "exchange": "",
    "country": "Korea | USA | Other",
    "sentiment": "ê¸ì • | ë¶€ì • | ì¤‘ë¦½",
    "sentiment_reason": "",
    "stock_code": null
  }
}

============================================================
ğŸ“Œ 5. relations ìŠ¤í‚¤ë§ˆ (í™•ì¥ëœ í•„ë“œ í¬í•¨)
============================================================

"relations": [
  {
    "source": "ê¸°ì—…ëª…",
    "target": "ê¸°ì—…ëª…",
    "relation_type": "ê³ ê°ì‚¬ | ê³µê¸‰ì‚¬ | ê²½ìŸì‚¬ | íŒŒíŠ¸ë„ˆ",
    "relation_reason": "",

    "source_is_listed": true,
    "source_country": "",
    "source_ticker": null,

    "target_is_listed": true,
    "target_country": "",
    "target_ticker": null
  }
]

âš ï¸ relations ì•ˆì—ëŠ” stock_codeë¥¼ ë„£ì§€ ë§ˆì„¸ìš”.  
âš ï¸ ëŒ€ì‹  source_ticker / target_tickerë§Œ ë„£ìŠµë‹ˆë‹¤.

============================================================
ğŸ“Œ 5-1. relationsì— ì ìš©ë˜ëŠ” ê¸°ì—…ëª… ì •ê·œí™” ê·œì¹™ (ì•„ì£¼ ì¤‘ìš”)
============================================================

- relations ë‚´ë¶€ì˜ source, target ê°’ì€ ë°˜ë“œì‹œ companies ê°ì²´ì˜
  "mapped_name" ê°’ê³¼ 100% ë™ì¼í•´ì•¼ í•©ë‹ˆë‹¤.

- ì¦‰, ê¸ˆìœµ ê³„ì—´ì‚¬ê°€ ë“±ì¥í•´ companies[mapped_name]ì´ ì§€ì£¼ì‚¬ë¡œ í†µì¼ë˜ì—ˆìœ¼ë©´,
  relations ì•ˆì—ì„œë„ ë°˜ë“œì‹œ ì§€ì£¼ì‚¬ëª…ë§Œ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.

- ê¸°ì‚¬ì—ì„œ ê´€ê³„ê°€ ëª…í™•í•˜ê²Œ ë“œëŸ¬ë‚˜ì§€ ì•Šìœ¼ë©´ relations ë°°ì—´ì— ì•„ë¬´ê²ƒë„ ì¶”ê°€í•˜ì§€ ë§ˆì„¸ìš”.

- ê¸°ì—…ì„ ì¶”ì¶œí•  ë•Œ, ë‚˜ë¼ ë˜ëŠ” ì¥ì†ŒëŠ” ì¶”ì¶œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

============================================================
ğŸ“Œ 6. ë¶„ì„ ëŒ€ìƒ ê¸°ì‚¬ ì œëª©
{{TITLE}}

ğŸ“Œ 7. ë¶„ì„ ëŒ€ìƒ ê¸°ì‚¬ ë³¸ë¬¸
{{CONTENT}}

============================================================
ğŸ¯ ë°˜ë“œì‹œ ìˆœìˆ˜ JSONë§Œ ì¶œë ¥í•˜ì„¸ìš”.
============================================================

============================================================
ğŸ“Œ JSON ìµœìƒìœ„ í•„ë“œ
============================================================

{
  "summary": "",
  "companies": {},
  "relations": []
}

`;
  prompt = prompt
    .replace("{{TITLE}}", article.title)
    .replace("{{CONTENT}}", article.content)
    .replace("{{CORP_LIST}}", JSON.stringify(Array.from(corpSet)));

  const response = await client.chat.completions.create({
    model: "gpt-4o",
    messages: [{ role: "user", content: prompt }],
    temperature: 0,
  });

  const rawOutput = response.choices[0].message.content;
  const cleaned = cleanJSON(rawOutput);

  try {
    const parsed = JSON.parse(cleaned);
    return normalizeMappedName(parsed);
  } catch (err) {
    console.error("âŒ JSON íŒŒì‹± ì‹¤íŒ¨:");
    console.error(cleaned);
    throw err;
  }
}

module.exports = analyzeArticle;
